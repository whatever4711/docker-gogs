# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

description: |
  Install/configure docker with buildx to
  cross-compile docker images and deploy them

orbs:
  bt: circleci/build-tools@2.6.3
  orb-tools: circleci/orb-tools@8.8.0
  docker: circleci/docker@0.5.13

jobs:
  steps:
    - run:
        name: Install buildx
        command: |
          BUILDX_BINARY_URL="https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64"

          curl --output docker-buildx \
            --silent --show-error --location --fail --retry 3 \
            "$BUILDX_BINARY_URL"

          mkdir -p ~/.docker/cli-plugins

          mv docker-buildx ~/.docker/cli-plugins/
          chmod a+x ~/.docker/cli-plugins/docker-buildx

          docker buildx install
          # Run binfmt
          docker run --rm --privileged docker/binfmt:a7996909642ee92942dcd6cff44b9b95f08dad64
